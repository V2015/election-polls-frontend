"use strict";angular.module("electionPollsApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","restangular","d3"]).config(["$routeProvider","RestangularProvider",function(a,b){a.when("/",{templateUrl:"views/main.html",controller:"MainController",resolve:{pollData:["Restangular",function(a){return a.all("polls.json").getList().then(function(a){return a},function(){return[]})}],partyData:["Restangular",function(a){return a.all("parties.json").getList().then(function(a){return a},function(){return[]})}]}}).when("/about",{templateUrl:"views/about.html"}).when("/parties/:id",{templateUrl:"views/party.html",controller:"PartyController",resolve:{partyResults:["Restangular","$route",function(a,b){return a.service("parties").one(b.current.params.id+".json").get().then(function(a){return a},function(){return[]})}]}}).otherwise({redirectTo:"/"}),b.setBaseUrl("https://v15electionpolls.herokuapp.com")}]),angular.module("d3",[]).factory("d3Service",["$document","$q","$rootScope",function(a,b,c){function d(){c.$apply(function(){e.resolve(window.d3)})}var e=b.defer(),f=a[0].createElement("script");f.type="text/javascript",f.async=!0,f.src="bower_components/d3/d3.js",f.onreadystatechange=function(){"complete"===this.readyState&&d()},f.onload=d;var g=a[0].getElementsByTagName("body")[0];return g.appendChild(f),{d3:function(){return e.promise}}}]),angular.module("electionPollsApp").service("pollService",[function(){this.addAveragePoll=function(a){var b={source:"ממוצע",results:this.averageResults(a)};return a.push(b),a},this.averageResults=function(a){var b={};_.each(a,function(a){_.each(a.results,function(a){_.isUndefined(b[a.party_id])&&(b[a.party_id]={party_id:a.party_id,mandates:0}),b[a.party_id].mandates+=a.mandates})});var c=a.length;return _.map(b,function(a){return{party_id:a.party_id,mandates:a.mandates/c}})}}]),angular.module("electionPollsApp").directive("simpleLineChart",["d3Service","$location","$rootScope",function(a,b,c){return{restrict:"EA",link:function(d){a.d3().then(function(a){function e(a){c.$apply(function(){b.path("/parties/"+a)})}var f={top:20,right:20,bottom:70,left:40},g=600-f.left-f.right,h=300-f.top-f.bottom;d.$watch("selectedPoll.results",function(b){if(b){$("#main-chart-container").html("");var c=a.select("#main-chart-container").append("svg").attr("width",g+f.left+f.right).attr("height",h+f.top+f.bottom).append("g").attr("transform","translate("+f.left+","+f.top+")"),i=a.scale.ordinal().domain(_.map(b,function(a){return d.partyName(a.party_id)})).rangeRoundBands([0,g],.55),j=a.scale.linear().domain([_.min(_.pluck(b,"mandates")),_.max(_.pluck(b,"mandates"))]).range([h,0]),k=a.svg.axis().scale(i).orient("bottom"),l=a.svg.axis().scale(j).orient("left");c.append("g").attr("class","x axis").attr("transform","translate(0,"+h+")").call(k);{c.select(".axis.x").selectAll(".tick").data(b).append("svg:image").attr("xlink:href",function(a){return"data:image/png;base64,"+d.partyImage(a.party_id)}).attr("width",32).attr("height",32).attr("x",-20).attr("y",20)}c.append("g").attr("class","y axis").call(l),c.selectAll("bar").data(b).enter().append("rect").style("fill","steelblue").attr("x",function(a){return i(d.partyName(a.party_id))}).attr("width","20px").attr("y",function(a){return j(a.mandates)}).attr("height",function(a){return h-j(a.mandates)}).on("click",function(a){e(a.party_id)})}})})}}}]),angular.module("electionPollsApp").directive("partyBarChart",["d3Service","$location","$rootScope",function(a){return{restrict:"EA",link:function(b){a.d3().then(function(a){var c={top:20,right:20,bottom:70,left:40},d=600-c.left-c.right,e=300-c.top-c.bottom,f=a.time.format("%Y-%m-%d").parse;b.$watch("results",function(b){if(b){$("#party-chart-container").html("");var g=a.select("#party-chart-container").append("svg").attr("width",d+c.left+c.right).attr("height",e+c.top+c.bottom).append("g").attr("transform","translate("+c.left+","+c.top+")"),h=a.scale.ordinal().rangeRoundBands([0,d],.05).domain(b.map(function(a){return f(a.date)})),i=a.scale.linear().domain([0,_.max(_.pluck(b,"mandates"))]).range([e,0]),j=a.svg.axis().scale(h).orient("bottom").tickFormat(a.time.format("%Y-%m-%d")),k=a.svg.axis().scale(i).orient("left");g.append("g").attr("class","x axis").attr("transform","translate(0,"+e+")").call(j),g.append("g").attr("class","y axis").call(k),g.selectAll("bar").data(b).enter().append("rect").style("fill","steelblue").attr("x",function(a){return h(f(a.date))}).attr("width","20px").attr("y",function(a){return i(a.mandates)}).attr("height",function(a){return e-i(a.mandates)})}})})}}}]),angular.module("electionPollsApp").controller("MainController",["$scope","pollData","partyData","pollService","$route",function(a,b,c,d){a.pollData=d.addAveragePoll(b),a.selectedPoll=a.pollData[0],a.partyData=c,a.partyName=function(b){return _.findWhere(a.partyData,{id:b}).name},a.partyImage=function(b){return _.findWhere(a.partyData,{id:b}).image},a.navigateToPartyPage=function(a){alert(a)}}]),angular.module("electionPollsApp").controller("PartyController",["$scope","partyResults",function(a,b){a.partyResults=b}]),angular.module("electionPollsApp").controller("AboutCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]);