"use strict";angular.module("electionPollsApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","restangular","d3"]).config(["$routeProvider","RestangularProvider",function(a,b){a.when("/",{templateUrl:"views/main.html",controller:"MainController",resolve:{pollData:["Restangular",function(a){return a.all("polls.json").getList().then(function(a){return a},function(){return[]})}],partyData:["Restangular",function(a){return a.all("parties.json").getList().then(function(a){return a},function(){return[]})}]}}).when("/guess",{templateUrl:"views/guess.html",controller:"GuessController",resolve:{partyData:["Restangular",function(a){return a.all("parties.json").getList().then(function(a){return a},function(){return[]})}]}}).when("/contact",{templateUrl:"views/contact.html"}).when("/parties/:id",{templateUrl:"views/party.html",controller:"PartyController",resolve:{partyResults:["Restangular","$route",function(a,b){return a.service("parties").one(b.current.params.id+".json").get().then(function(a){return a},function(){return[]})}]}}).otherwise({redirectTo:"/"}),b.setBaseUrl("https://v15electionpolls.herokuapp.com")}]),angular.module("d3",[]).factory("d3Service",["$document","$q","$rootScope",function(a,b,c){function d(){c.$apply(function(){e.resolve(window.d3)})}var e=b.defer(),f=a[0].createElement("script");f.type="text/javascript",f.async=!0,f.src="bower_components/d3/d3.js",f.onreadystatechange=function(){"complete"===this.readyState&&d()},f.onload=d;var g=a[0].getElementsByTagName("body")[0];return g.appendChild(f),{d3:function(){return e.promise}}}]),angular.module("electionPollsApp").service("pollService",[function(){var a=[14,15,16,19],b=[17,18],c=[20,21],d=[22,23],e=[24,25,26];this.addAveragePoll=function(a){var b={source:"ממוצע 7 סקרים אחרונים",results:this.averageResults(a.slice(0,7))};return a.unshift(b),a},this.averageResults=function(a){var b={};_.each(a,function(a){_.each(a.results,function(a){_.isUndefined(b[a.party_id])&&(b[a.party_id]={party_id:a.party_id,mandates:0}),b[a.party_id].mandates+=a.mandates})});var c=a.length;return _.sortBy(_.map(b,function(a){return{party_id:a.party_id,mandates:parseInt(a.mandates/c)}}),function(a){return a.mandates}).reverse()},this.getPieData=function(f){var g=[{chunk:"right",mandates:0},{chunk:"center",mandates:0},{chunk:"religious",mandates:0},{chunk:"left",mandates:0},{chunk:"arabs",mandates:0}];return _.each(f.results,function(f){_.contains(a,parseInt(f.party_id))&&(g[0].mandates+=f.mandates),_.contains(b,parseInt(f.party_id))&&(g[1].mandates+=f.mandates),_.contains(c,parseInt(f.party_id))&&(g[2].mandates+=f.mandates),_.contains(d,parseInt(f.party_id))&&(g[3].mandates+=f.mandates),_.contains(e,parseInt(f.party_id))&&(g[4].mandates+=f.mandates)}),g}}]),angular.module("electionPollsApp").directive("pollBarChart",["$rootScope","$location","d3Service",function(a,b,c){return{restrict:"EA",link:function(d){function e(c){a.$apply(function(){b.path("/parties/"+c)})}c.d3().then(function(){d.$watch("selectedPoll",function(a){c3.generate({bindto:"#main-chart-container",data:{columns:[[a.source].concat(_.map(a.results,"mandates"))],type:"bar",onclick:function(b){var c=a.results[b.index].party_id;e(c)},color:function(b,c){return c.id?d.partyColor(a.results[c.index].party_id):void 0},labels:!0},bar:{width:{ratio:.5}},axis:{x:{type:"category",categories:_.map(a.results,function(a){return d.partyName(a.party_id)})},y:{show:!1}},grid:{y:{show:!0}},legend:{show:!1},padding:{left:20,right:20,top:30},onresized:f});setTimeout(function(){f()},400)})});var f=function(){setTimeout(function(){d3.selectAll(".c3-text").attr("y",250)},0)}}}}]),angular.module("electionPollsApp").directive("pieChart",[function(){return{restrict:"EA",link:function(a){a.$watch("pieData",function(a){c3.generate({bindto:"#pie-chart-container",data:{columns:_.map(a,function(a){return[a.chunk,a.mandates]}),type:"pie"}})})}}}]),angular.module("electionPollsApp").directive("partyBarChart",[function(){return{restrict:"EA",link:function(a){{var b=_.sortBy(a.partyResults.results.slice(0,10),function(a){return Date.parse(a.poll.date)});c3.generate({bindto:"#party-chart-container",data:{columns:[[a.partyResults.name].concat(_.map(b,"mandates"))],type:"bar"},bar:{width:{ratio:.5}},axis:{x:{type:"category",categories:_.map(b,function(a){return a.poll.date+"("+a.poll.source+")"})}}})}}}}]),angular.module("electionPollsApp").directive("guessPieChart",[function(){return{restrict:"EA",link:function(a){a.$watch("guess",function(b){c3.generate({bindto:"#guess-chart-container",data:{columns:_.map(b,function(a){return[a.name,parseInt(a.mandates)]}).concat([["Remaining",a.getRemaining()]]),type:"pie"}})},!0)}}}]),angular.module("electionPollsApp").directive("pollSelect",["$document",function(a){return{link:function(b,c){var d=function(){angular.element("#poll-list").removeClass("collapsed"),a.bind("click",e)},e=function(b){{var d=c.has(b.target).length>0,f=c[0]==b.target,g=d||f,h=angular.element("#poll-list");h.hasClass("collapsed")}g||(angular.element("#poll-list").addClass("collapsed"),a.unbind("click",e))};angular.element("#switch-poll").on("click",d)}}}]),angular.module("electionPollsApp").controller("MainController",["$scope","pollData","partyData","pollService","$route",function(a,b,c,d){a.pollData=d.addAveragePoll(b),a.selectedPoll=a.pollData[0],a.partyData=c,a.pollView="bar",a.pieData=[],a.$watch("selectedPoll",function(b){a.pieData=d.getPieData(b)}),a.selectPoll=function(b){a.selectedPoll=b},a.partyName=function(b){return _.findWhere(a.partyData,{id:b}).name},a.partyColor=function(b){return _.findWhere(a.partyData,{id:b}).color},a.partyImage=function(b){return _.findWhere(a.partyData,{id:b}).image},a.navigateToPartyPage=function(a){alert(a)}}]),angular.module("electionPollsApp").controller("PartyController",["$scope","partyResults",function(a,b){a.partyResults=b}]),angular.module("electionPollsApp").controller("GuessController",["$scope","partyData",function(a,b){function c(){_.each(b,function(b){a.guess.push({name:b.name,mandates:0})})}a.partyData=b,a.guess=[],c(),a.getRemaining=function(){return 120-_.reduce(a.guess,function(a,b){return a+parseInt(b.mandates)},0)}}]);