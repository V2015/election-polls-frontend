"use strict";angular.module("electionPollsApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","restangular","d3"]).config(["$routeProvider","RestangularProvider",function(a,b){a.when("/",{templateUrl:"views/main.html",controller:"MainController",resolve:{pollData:["Restangular",function(a){return a.all("polls.json").getList().then(function(a){return a},function(){return[]})}],partyData:["Restangular",function(a){return a.all("parties.json").getList().then(function(a){return a},function(){return[]})}]}}).when("/about",{templateUrl:"views/about.html"}).when("/contact",{templateUrl:"views/contact.html"}).when("/parties/:id",{templateUrl:"views/party.html",controller:"PartyController",resolve:{partyResults:["Restangular","$route",function(a,b){return a.service("parties").one(b.current.params.id+".json").get().then(function(a){return a},function(){return[]})}]}}).otherwise({redirectTo:"/"}),b.setBaseUrl("https://v15electionpolls.herokuapp.com")}]),angular.module("d3",[]).factory("d3Service",["$document","$q","$rootScope",function(a,b,c){function d(){c.$apply(function(){e.resolve(window.d3)})}var e=b.defer(),f=a[0].createElement("script");f.type="text/javascript",f.async=!0,f.src="bower_components/d3/d3.js",f.onreadystatechange=function(){"complete"===this.readyState&&d()},f.onload=d;var g=a[0].getElementsByTagName("body")[0];return g.appendChild(f),{d3:function(){return e.promise}}}]),angular.module("electionPollsApp").service("pollService",[function(){var a=[14,15,16,19],b=[17,18],c=[20,21],d=[22,23],e=[24,25,26];this.addAveragePoll=function(a){var b={source:"ממוצע",results:this.averageResults(a)};return a.push(b),a},this.averageResults=function(a){var b={};_.each(a,function(a){_.each(a.results,function(a){_.isUndefined(b[a.party_id])&&(b[a.party_id]={party_id:a.party_id,mandates:0}),b[a.party_id].mandates+=a.mandates})});var c=a.length;return _.map(b,function(a){return{party_id:a.party_id,mandates:a.mandates/c}})},this.getPieData=function(f){var g=[{chunk:"right",mandates:0},{chunk:"center",mandates:0},{chunk:"religious",mandates:0},{chunk:"left",mandates:0},{chunk:"arabs",mandates:0}];return _.each(f.results,function(f){_.contains(a,parseInt(f.party_id))&&(g[0].mandates+=f.mandates),_.contains(b,parseInt(f.party_id))&&(g[1].mandates+=f.mandates),_.contains(c,parseInt(f.party_id))&&(g[2].mandates+=f.mandates),_.contains(d,parseInt(f.party_id))&&(g[3].mandates+=f.mandates),_.contains(e,parseInt(f.party_id))&&(g[4].mandates+=f.mandates)}),g}}]),angular.module("electionPollsApp").directive("simpleLineChart",["d3Service","$location","$rootScope",function(a,b,c){return{restrict:"EA",link:function(d){a.d3().then(function(a){function e(a){c.$apply(function(){b.path("/parties/"+a)})}function f(){n=parseInt(a.select("#main-chart-container").style("width"))-2*m.top,o=parseInt(a.select("#main-chart-container").style("height"))-2*m.top,i.rangeRoundBands([0,n],.55),j.range([o,0]),h.select(".x.axis").attr("transform","translate(0,"+o+")").call(k),h.select(".y.axis").call(l),h.selectAll("rect").data(g).attr("x",function(a){return i(d.partyName(a.party_id))}).attr("width",i.rangeBand()).attr("y",function(a){return j(a.mandates)}).attr("height",function(a){return o-j(a.mandates)})}a.select(window).on("resize",f);var g,h,i,j,k,l,m={top:20,right:20,bottom:70,left:40},n=parseInt(a.select("#main-chart-container").style("width")),o=parseInt(a.select("#main-chart-container").style("height"))-2*m.top;d.$watch("selectedPoll.results",function(b){if(b){g=b,$("#main-chart-container").html(""),h=a.select("#main-chart-container").append("svg").attr("width",n).attr("height",o+m.top+m.bottom).append("g").attr("transform","translate("+m.left+","+m.top+")"),i=a.scale.ordinal().domain(_.map(b,function(a){return d.partyName(a.party_id)})).rangeRoundBands([0,n],.55),j=a.scale.linear().domain([_.min(_.pluck(b,"mandates")),_.max(_.pluck(b,"mandates"))]).range([o,0]),k=a.svg.axis().scale(i).orient("bottom"),l=a.svg.axis().scale(j).orient("left"),h.append("g").attr("class","x axis").attr("transform","translate(0,"+o+")").call(k);{h.select(".axis.x").selectAll(".tick").data(b).append("svg:image").attr("xlink:href",function(a){return"data:image/png;base64,"+d.partyImage(a.party_id)}).attr("width",32).attr("height",32).attr("x",-20).attr("y",20)}h.append("g").attr("class","y axis").call(l),h.selectAll("bar").data(b).enter().append("rect").style("fill","steelblue").attr("x",function(a){return i(d.partyName(a.party_id))}).attr("width",i.rangeBand()).attr("y",function(a){return j(a.mandates)}).attr("height",function(a){return o-j(a.mandates)}).on("click",function(a){e(a.party_id)})}f()})})}}}]),angular.module("electionPollsApp").directive("pieChart",["d3Service","$rootScope",function(a){return{restrict:"EA",link:function(b){a.d3().then(function(a){var c={top:20,right:20,bottom:20,left:20},d=parseInt(a.select("#pie-chart-container").style("width")),e=parseInt(a.select("#pie-chart-container").style("height"))-2*c.top,f=Math.min(d,e)/2,g=a.scale.ordinal().range(["#98abc5","#8a89a6","#7b6888","#6b486b","#a05d56"]),h=a.svg.arc().outerRadius(f-10).innerRadius(0),i=a.layout.pie().sort(null).value(function(a){return a.mandates});b.$watch("pieData",function(b){if(b){$("#pie-chart-container").html("");var c=a.select("#pie-chart-container").append("svg").attr("width",d).attr("height",e).append("g").attr("transform","translate("+d/2+","+e/2+")"),f=c.selectAll(".arc").data(i(b)).enter().append("g").attr("class","arc");f.append("path").attr("d",h).style("fill",function(a){return g(a.data.chunk)}),f.append("text").attr("transform",function(a){return"translate("+h.centroid(a)+")"}).attr("dy",".35em").style("text-anchor","middle").text(function(a){return a.data.chunk+"("+a.data.mandates+")"})}})})}}}]),angular.module("electionPollsApp").directive("partyBarChart",["d3Service","$location","$rootScope",function(a){return{restrict:"EA",link:function(b){a.d3().then(function(a){function c(){var b=parseInt(a.select("#party-chart-container").style("width"))-2*i.top,c=parseInt(a.select("#party-chart-container").style("height"))-2*i.top;l.rangeRoundBands([0,b],.05),m.range([c,0]),d.select(".x.axis").attr("transform","translate(0,"+c+")").call(e),d.select(".y.axis").call(f),d.selectAll("rect").data(h).attr("x",function(a){return l(a.id)}).attr("width",l.rangeBand()).attr("y",function(a){return m(a.value)}).attr("height",function(a){return c-m(a.value)})}a.select(window).on("resize",c);var d,e,f,g,h,i={top:20,right:20,bottom:70,left:40},j=parseInt(a.select("#party-chart-container").style("width")),k=parseInt(a.select("#party-chart-container").style("height"))-2*i.top,l=(a.time.format("%Y-%m-%d").parse,a.scale.ordinal().rangeRoundBands([0,j],.05)),m=a.scale.linear().range([k,0]);b.$watch("partyResults.results",function(b){b&&(b=_.sortBy(b.slice(0,10),function(a){return Date.parse(a.poll.date)}),h=b,e=a.svg.axis().scale(l).orient("bottom"),f=a.svg.axis().scale(m).orient("left").ticks(10),$("#party-chart-container").html(""),d=a.select("#party-chart-container").append("svg").attr("width",j).attr("height",k+i.top+i.bottom).append("g").attr("transform","translate("+i.left+","+i.top+")"),b.forEach(function(a){a.id=a.id,a.value=a.mandates}),l.domain(b.map(function(a){return a.id})),m.domain([0,a.max(b,function(a){return a.value})]),d.append("g").attr("class","x axis").attr("transform","translate(0,"+k+")").call(e).selectAll("text").style("text-anchor","end").attr("dx","-.8em").attr("dy","-.55em").attr("transform","rotate(-60)").data(b).text(function(a){return a.poll.date}),d.append("g").attr("class","y axis").call(f).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text("Mandates"),g=d.selectAll("bar").data(b).enter().append("rect").style("fill","steelblue").attr("x",function(a){return l(a.id)}).attr("width",l.rangeBand()).attr("y",function(a){return m(a.value)}).attr("height",function(a){return k-m(a.value)}),c())})})}}}]),angular.module("electionPollsApp").controller("MainController",["$scope","pollData","partyData","pollService","$route",function(a,b,c,d){a.pollData=d.addAveragePoll(b),a.selectedPoll=a.pollData[0],a.partyData=c,a.pollView="bar",a.pieData=[],a.$watch("selectedPoll",function(b){a.pieData=d.getPieData(b)}),a.partyName=function(b){return _.findWhere(a.partyData,{id:b}).name},a.partyImage=function(b){return _.findWhere(a.partyData,{id:b}).image},a.navigateToPartyPage=function(a){alert(a)}}]),angular.module("electionPollsApp").controller("PartyController",["$scope","partyResults",function(a,b){a.partyResults=b}]),angular.module("electionPollsApp").controller("AboutCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]);